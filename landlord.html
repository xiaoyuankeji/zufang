<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿ä¸œå·¥ä½œå° | é‡Œå°”ç§Ÿæˆ¿</title>
    <!-- CDNï¼ˆé€‚é…æ³•å›½ç½‘ç»œç¯å¢ƒï¼‰ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #F3F4F6; }
        .glass-panel { background: white; border: 1px solid #E5E7EB; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body>
    <!-- é˜²å‘†ï¼šå¦‚æœç”¨æˆ·ç”¨ file:// æ‰“å¼€ï¼Œä¼šå¯¼è‡´å¾ˆå¤šç½‘ç»œ/è·¨åŸŸé—®é¢˜ -->
    <div id="protocol-warning" style="display:none; padding:16px; background:#FEF3C7; border-bottom:1px solid #F59E0B; color:#92400E; font-weight:700;">
        æ£€æµ‹åˆ°ä½ æ­£åœ¨ç”¨ <code>file://</code> æ–¹å¼æ‰“å¼€é¡µé¢ï¼ˆä¼šå¯¼è‡´æ¥å£è¯·æ±‚å¤±è´¥ï¼‰ã€‚è¯·ç”¨æœ¬åœ°æœåŠ¡å™¨è®¿é—®ï¼š
        <a href="http://localhost:3000/landlord.html" style="text-decoration:underline; font-weight:900;">http://localhost:3000/landlord.html</a>
        <button id="open-local-btn" style="margin-left:12px; padding:6px 10px; border:1px solid #F59E0B; background:#fff; border-radius:8px; cursor:pointer; font-weight:900;">
          ä¸€é”®æ‰“å¼€
        </button>
    </div>
    <script>
      (function () {
        try {
          if (location.protocol === 'file:') {
            var el = document.getElementById('protocol-warning');
            if (el) el.style.display = 'block';
            var btn = document.getElementById('open-local-btn');
            if (btn) {
              btn.addEventListener('click', function () {
                window.location.href = 'http://localhost:3000/landlord.html';
              });
            }
            // è‡ªåŠ¨è·³è½¬ï¼ˆé¿å…ç”¨æˆ·æ€»æ˜¯åŒå‡»æ–‡ä»¶å¯¼è‡´ Failed to fetchï¼‰
            // ç»™ 800ms è®©ç”¨æˆ·çœ‹åˆ°æç¤ºï¼›å¦‚æœæœ¬åœ°æœåŠ¡æ²¡å¼€ï¼Œè·³è½¬ä¼šå¤±è´¥ä½†ä¸ä¼šå½±å“ç»§ç»­æŸ¥çœ‹é¡µé¢ã€‚
            setTimeout(function () {
              try { window.location.href = 'http://localhost:3000/landlord.html'; } catch (e) {}
            }, 800);
          }
        } catch (e) {}
      })();
    </script>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- API é…ç½® ---
        // å¼ºåˆ¶æŒ‡å‘åç«¯ 3001 ç«¯å£ï¼Œè§£å†³ CORS/ç«¯å£ä¸ä¸€è‡´é—®é¢˜
        const API_URL = 'http://127.0.0.1:3001/api/v1';

        // --- å·¥å…·å‡½æ•°ï¼šFetch å°è£… (è‡ªåŠ¨å¸¦ Token) ---
        const api = async (endpoint, method = 'GET', body = null) => {
            const token = localStorage.getItem('token');
            console.log(`ğŸ“¡ [API Request] ${method} ${endpoint}`);
            if (token) console.log(`ğŸ”‘ Token found: ${token.substring(0, 10)}...`);
            else console.warn("âš ï¸ No token found in localStorage");

            const headers = {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            };

            const config = {
                method,
                headers,
                ...(body && { body: JSON.stringify(body) })
            };

            try {
                const url = `${API_URL}${endpoint}`;
                console.log(`ğŸŒ Full URL: ${url}`);
                
                const res = await fetch(url, config);
                console.log(`ğŸ“© [API Response Status] ${res.status}`);

                const data = await res.json();
                console.log("ğŸ“¦ [API Response Data]", data);

                if (!res.ok) {
                    console.error("âŒ API Error:", data.message);
                    if (res.status === 401) {
                        alert("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.reload();
                    }
                    throw new Error(data.message || 'Request failed');
                }
                return data;
            } catch (err) {
                console.error("âŒ [Network/Logic Error]", err);
                throw err;
            }
        };

        // --- Lucide Icon ç»„ä»¶ ---
        const LucideIcon = ({ name, size = 24, className = '' }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && lucide && lucide.createIcons) {
                    lucide.createIcons({
                        icons: { [name]: lucide.icons[name] },
                        nameAttr: 'data-lucide',
                        attrs: { class: className, width: size, height: size }
                    });
                    const svg = lucide.icons[name]?.toSvg({ class: className, width: size, height: size });
                    if(svg) ref.current.innerHTML = svg;
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center"></span>;
        };

        // --- ç™»å½•/æ³¨å†Œé¡µé¢ ---
        const AuthPage = ({ onLogin }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [formData, setFormData] = useState({ email: '', password: '', name: '', wechatId: '' });
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                try {
                    const endpoint = isLogin ? '/auth/login' : '/auth/signup';
                    const res = await api(endpoint, 'POST', formData);
                    
                    if (res.token) {
                        localStorage.setItem('token', res.token);
                        localStorage.setItem('user', JSON.stringify(res.data.user));
                        onLogin(res.data.user);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2 text-center">
                            {isLogin ? 'æˆ¿ä¸œç™»å½•' : 'æ³¨å†Œæˆ¿ä¸œè´¦å·'}
                        </h2>
                        <p className="text-gray-500 text-center mb-8">é‡Œå°”ç§Ÿæˆ¿ Lierzufang.com</p>
                        
                        {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg mb-4 text-sm">{error}</div>}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {!isLogin && (
                                <>
                                    <input 
                                        type="text" 
                                        placeholder="æ˜¾ç¤ºæ˜µç§°"
                                        className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none"
                                        value={formData.name}
                                        onChange={e => setFormData({...formData, name: e.target.value})}
                                        required
                                    />
                                    <input 
                                        type="text" 
                                        placeholder="å¾®ä¿¡å· (ç”¨äºæ¥æ”¶é€šçŸ¥)"
                                        className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none"
                                        value={formData.wechatId}
                                        onChange={e => setFormData({...formData, wechatId: e.target.value})}
                                        required
                                    />
                                </>
                            )}
                            <input 
                                type="email" 
                                placeholder="ç”µå­é‚®ç®±"
                                className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none"
                                value={formData.email}
                                onChange={e => setFormData({...formData, email: e.target.value})}
                                required
                            />
                            <input 
                                type="password" 
                                placeholder="å¯†ç "
                                className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none"
                                value={formData.password}
                                onChange={e => setFormData({...formData, password: e.target.value})}
                                required
                            />
                            
                            <button 
                                type="submit" 
                                disabled={loading}
                                className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-colors disabled:opacity-50"
                            >
                                {loading ? 'å¤„ç†ä¸­...' : (isLogin ? 'ç™»å½•' : 'æ³¨å†Œ')}
                            </button>
                        </form>

                        <div className="mt-6 text-center">
                            <button 
                                onClick={() => setIsLogin(!isLogin)}
                                className="text-blue-600 text-sm hover:underline"
                            >
                                {isLogin ? 'æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ' : 'å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- æˆ¿æºç®¡ç†é¢æ¿ ---
        const ListingsPanel = ({ userId, onBalanceUpdate }) => {
            const [listings, setListings] = useState([]);
            const [isEditing, setIsEditing] = useState(false);
            const [editData, setEditData] = useState(null);
            const [promotingId, setPromotingId] = useState(null);
            
            // Initial Form State
            const initialForm = {
                title: '', price: '', location: '', description: '', tags: '', images: []
            };
            const [formData, setFormData] = useState(initialForm);
            const [uploading, setUploading] = useState(false);

            useEffect(() => {
                fetchMyListings();
            }, []);

            const fetchMyListings = async () => {
                try {
                    const res = await api('/listings/my');
                    setListings(res.data.listings);
                } catch (err) {
                    console.error(err);
                }
            };

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setUploading(true);
                const formData = new FormData();
                formData.append('image', file);

                try {
                    const token = localStorage.getItem('token');
                    // æ˜¾å¼ä½¿ç”¨ API_URL å¸¸é‡ï¼Œé˜²æ­¢ fetch ä½¿ç”¨ç›¸å¯¹è·¯å¾„
                    const res = await fetch(`${API_URL}/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    const data = await res.json();
                    
                    if (data.status === 'success') {
                        setFormData(prev => ({
                            ...prev,
                            images: [...(prev.images || []), data.data.url]
                        }));
                    } else {
                        alert('ä¸Šä¼ å¤±è´¥: ' + data.message);
                    }
                } catch (err) {
                    alert('ä¸Šä¼ å‡ºé”™');
                } finally {
                    setUploading(false);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    // Convert tags string to array
                    const payload = {
                        ...formData,
                        // æ”¯æŒè‹±æ–‡é€—å·/ä¸­æ–‡é€—å·/å¤šç©ºæ ¼åˆ†éš”ï¼Œé¿å… tags å˜æˆä¸€ä¸ªé•¿å­—ç¬¦ä¸²
                        tags: String(formData.tags || '')
                            .split(/[,\uFF0C]+/g)
                            .map(t => t.trim())
                            .filter(Boolean)
                    };

                    if (isEditing) {
                        await api(`/listings/${editData._id}`, 'PATCH', payload);
                        alert('æ›´æ–°æˆåŠŸ');
                    } else {
                        await api('/listings', 'POST', payload);
                        alert('å‘å¸ƒæˆåŠŸ');
                    }
                    
                    setIsEditing(false);
                    setEditData(null);
                    setFormData(initialForm);
                    fetchMyListings();
                } catch (err) {
                    alert('æ“ä½œå¤±è´¥: ' + err.message);
                }
            };

            const handleEdit = (item) => {
                setIsEditing(true);
                setEditData(item);
                setFormData({
                    title: item.title,
                    price: item.price,
                    location: item.location,
                    description: item.description || '',
                    tags: item.tags.join(', '),
                    images: item.images || []
                });
            };

            const handleDelete = async (id) => {
                if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªæˆ¿æºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
                try {
                    await api(`/listings/${id}`, 'DELETE');
                    fetchMyListings();
                } catch (err) {
                    alert('åˆ é™¤å¤±è´¥');
                }
            };

            const handlePromote = async (id) => {
                if (!confirm('ç¡®è®¤èŠ±è´¹ 10â‚¬ ç½®é¡¶ 7 å¤©å—ï¼Ÿï¼ˆæ¼”ç¤ºå®šä»·ï¼‰')) return;
                setPromotingId(id);
                try {
                    const res = await api(`/listings/${id}/promote`, 'POST', { days: 7, price: 10 });
                    const updated = res.data.listing;
                    const newBalance = res.data.balance;
                    setListings(prev => prev.map(l => l._id === id ? updated : l));
                    if (typeof onBalanceUpdate === 'function') onBalanceUpdate(newBalance);
                    alert('ç½®é¡¶æˆåŠŸï¼');
                } catch (err) {
                    if (String(err.message || '').includes('Insufficient balance')) {
                        alert('ä½™é¢ä¸è¶³ï¼Œè¯·å…ˆå……å€¼ã€‚');
                    } else {
                        alert('ç½®é¡¶å¤±è´¥ï¼š' + err.message);
                    }
                } finally {
                    setPromotingId(null);
                }
            };

            return (
                <div className="space-y-8">
                    {/* è¡¨å•åŒºåŸŸ */}
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 className="text-lg font-bold text-gray-800 mb-4">
                            {isEditing ? 'ç¼–è¾‘æˆ¿æº' : 'å‘å¸ƒæ–°æˆ¿æº'}
                        </h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input required type="text" placeholder="æˆ¿æºæ ‡é¢˜ (å¦‚: é‡Œå°”ä¸€å¤§é™„è¿‘ Studio)" className="p-3 rounded-lg border border-gray-200 w-full" 
                                    value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} />
                                <input required type="number" placeholder="æœˆç§Ÿ (â‚¬)" className="p-3 rounded-lg border border-gray-200 w-full" 
                                    value={formData.price} onChange={e => setFormData({...formData, price: e.target.value})} />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input required type="text" placeholder="ä½ç½®åŒºåŸŸ (å¦‚: Lille Sud)" className="p-3 rounded-lg border border-gray-200 w-full" 
                                    value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})} />
                                <input type="text" placeholder="æ ‡ç­¾ (é€—å·åˆ†éš”ï¼Œå¦‚: è¿‘åœ°é“, åŒ…ç½‘)" className="p-3 rounded-lg border border-gray-200 w-full" 
                                    value={formData.tags} onChange={e => setFormData({...formData, tags: e.target.value})} />
                            </div>
                            <textarea placeholder="è¯¦ç»†æè¿°..." className="p-3 rounded-lg border border-gray-200 w-full" rows="3"
                                value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})}></textarea>
                            
                            {/* å›¾ç‰‡ä¸Šä¼ åŒº */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">æˆ¿æºå›¾ç‰‡</label>
                                <div className="flex flex-wrap gap-4">
                                    {formData.images.map((url, idx) => (
                                        <div key={idx} className="relative w-24 h-24 rounded-lg overflow-hidden border border-gray-200 group">
                                            <img src={`http://127.0.0.1:3001${url}`} alt="Preview" className="w-full h-full object-cover" />
                                            <button 
                                                type="button"
                                                onClick={() => setFormData(prev => ({...prev, images: prev.images.filter((_, i) => i !== idx)}))}
                                                className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"
                                            >
                                                <LucideIcon name="x" size={12} />
                                            </button>
                                        </div>
                                    ))}
                                    <label className="w-24 h-24 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors">
                                        {uploading ? (
                                            <span className="text-xs text-gray-500">ä¸Šä¼ ä¸­...</span>
                                        ) : (
                                            <>
                                                <LucideIcon name="plus" size={24} className="text-gray-400" />
                                                <span className="text-xs text-gray-500 mt-1">ä¸Šä¼ å›¾ç‰‡</span>
                                            </>
                                        )}
                                        <input type="file" accept="image/*" className="hidden" onChange={handleImageUpload} disabled={uploading} />
                                    </label>
                                </div>
                            </div>

                            <div className="flex gap-2">
                                <button type="submit" className="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors">
                                    {isEditing ? 'ä¿å­˜ä¿®æ”¹' : 'ç«‹å³å‘å¸ƒ'}
                                </button>
                                {isEditing && (
                                    <button type="button" onClick={() => { setIsEditing(false); setFormData(initialForm); }} className="px-6 py-2 bg-gray-100 text-gray-600 font-bold rounded-lg">
                                        å–æ¶ˆ
                                    </button>
                                )}
                            </div>
                        </form>
                    </div>

                    {/* åˆ—è¡¨åŒºåŸŸ */}
                    <div>
                        <h3 className="text-lg font-bold text-gray-800 mb-4">æˆ‘çš„æˆ¿æºåˆ—è¡¨</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {listings.map(item => (
                                <div key={item._id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-start">
                                    <div>
                                        <h4 className="font-bold text-gray-900 line-clamp-1">{item.title}</h4>
                                        <p className="text-blue-600 font-bold">â‚¬{item.price}<span className="text-gray-400 text-xs font-normal">/æœˆ</span></p>
                                        <p className="text-xs text-gray-500 mt-1">{item.location} Â· {(item.tags || []).join(' ')}</p>
                                        <div className="mt-3 flex flex-wrap gap-2">
                                            <a
                                                href={`/listing?id=${encodeURIComponent(item._id)}`}
                                                target="_blank"
                                                className="px-3 py-1.5 rounded-lg text-xs font-bold bg-gray-100 text-gray-700 hover:bg-gray-200"
                                            >
                                                å‰å°é¢„è§ˆ
                                            </a>
                                            <button
                                                onClick={() => handleDelete(item._id)}
                                                className="px-3 py-1.5 rounded-lg text-xs font-bold bg-red-50 text-red-700 hover:bg-red-100 border border-red-200"
                                            >
                                                åˆ é™¤
                                            </button>
                                            <button
                                                onClick={() => handlePromote(item._id)}
                                                disabled={promotingId === item._id}
                                                className="px-3 py-1.5 rounded-lg text-xs font-bold bg-gradient-to-r from-orange-500 to-red-500 text-white hover:brightness-110 disabled:opacity-50"
                                            >
                                                {promotingId === item._id ? 'ç½®é¡¶ä¸­...' : 'ç½®é¡¶ 7 å¤©ï¼ˆ10â‚¬ï¼‰'}
                                            </button>
                                            <span className={`px-3 py-1.5 rounded-lg text-xs font-bold border ${item.reviewStatus === 'approved' ? 'bg-green-50 text-green-700 border-green-200' : item.reviewStatus === 'rejected' ? 'bg-red-50 text-red-700 border-red-200' : 'bg-yellow-50 text-yellow-800 border-yellow-200'}`}>
                                                {item.reviewStatus === 'approved' ? 'å·²é€šè¿‡å®¡æ ¸' : item.reviewStatus === 'rejected' ? 'å·²é©³å›' : 'å¾…å®¡æ ¸'}
                                            </span>
                                            {item.isPromoted && (
                                                <span className="px-3 py-1.5 rounded-lg text-xs font-bold bg-yellow-50 text-yellow-700 border border-yellow-200">
                                                    å·²ç½®é¡¶{item.promotedUntil ? `è‡³ ${new Date(item.promotedUntil).toLocaleDateString()}` : ''}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => handleEdit(item)} className="p-2 text-gray-400 hover:text-blue-600">
                                            <LucideIcon name="edit-2" size={18} />
                                        </button>
                                        <button onClick={() => handleDelete(item._id)} className="p-2 text-gray-400 hover:text-red-500">
                                            <LucideIcon name="trash-2" size={18} />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ä»ªè¡¨ç›˜ ---
        const Dashboard = ({ user, onLogout, onUserUpdate }) => {
            const [activeTab, setActiveTab] = useState('leads'); // leads, listings, wallet, settings
            const [leads, setLeads] = useState([]);
            const [balance, setBalance] = useState(user.balance || 0);
            const [loading, setLoading] = useState(true);
            const [payments, setPayments] = useState([]);
            const [paymentsLoading, setPaymentsLoading] = useState(false);
            const [showNonCompletedPayments, setShowNonCompletedPayments] = useState(false);
            const [topupAmount, setTopupAmount] = useState('50');
            const [topupLoading, setTopupLoading] = useState(false);
            const [stripeConfirming, setStripeConfirming] = useState(false);
            const [stripeConfirmError, setStripeConfirmError] = useState('');
            const [stripeSessionId, setStripeSessionId] = useState('');
            const [stripeSyncing, setStripeSyncing] = useState(false);
            const [stripeSyncMsg, setStripeSyncMsg] = useState('');
            const [stripeAutoSyncTried, setStripeAutoSyncTried] = useState(false);
            const [profileForm, setProfileForm] = useState({
                name: user.name || '',
                email: user.email || '',
                wechatId: user.wechatId || ''
            });
            const [profileSaving, setProfileSaving] = useState(false);

            useEffect(() => {
                // user å˜åŒ–ï¼ˆæ¯”å¦‚ç™»å½•/ä¿å­˜åï¼‰åŒæ­¥è¡¨å•
                setProfileForm({
                    name: user.name || '',
                    email: user.email || '',
                    wechatId: user.wechatId || ''
                });
            }, [user?.name, user?.email, user?.wechatId]);

            // ä½“éªŒä¼˜åŒ–ï¼šè¿›å…¥å·¥ä½œå°åä¸»åŠ¨åŒæ­¥ä¸€æ¬¡â€œæœ€æ–°ä½™é¢/èµ„æ–™â€ï¼Œé¿å…â€œå……å€¼æˆåŠŸå›è·³ä½†ä»æ˜¾ç¤ºæ—§ä½™é¢â€
            useEffect(() => {
                (async () => {
                    try {
                        const res = await api('/auth/me', 'GET');
                        const fresh = res?.data?.user;
                        if (fresh && typeof fresh.balance === 'number') {
                            setBalance(fresh.balance);
                            localStorage.setItem('user', JSON.stringify(fresh));
                            if (typeof onUserUpdate === 'function') onUserUpdate(fresh);
                        }
                    } catch (e) {
                        // ignore
                    }
                })();
            }, []);

            useEffect(() => {
                fetchLeads();
            }, []);

            useEffect(() => {
                // è¿›å…¥é’±åŒ…é¡µæ—¶å†æ‹‰å–ï¼ˆå‡å°‘æ— æ„ä¹‰è¯·æ±‚ï¼‰
                if (activeTab === 'wallet') {
                    fetchPayments();
                }
            }, [activeTab]);

            const fetchLeads = async () => {
                console.log("ğŸš€ å¼€å§‹è·å–çº¿ç´¢åˆ—è¡¨...");
                try {
                    const res = await api('/leads');
                    console.log("âœ… çº¿ç´¢è·å–æˆåŠŸï¼Œæ•°é‡:", res.data.leads.length);
                    setLeads(res.data.leads);
                } catch (err) {
                    console.error("âŒ è·å–çº¿ç´¢å¤±è´¥:", err);
                    alert('è·å–çº¿ç´¢å¤±è´¥: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const fetchPayments = async () => {
                setPaymentsLoading(true);
                try {
                    const res = await api('/payments/my');
                    setPayments(res.data.payments || []);
                } catch (err) {
                    alert('è·å–å……å€¼/æ¶ˆè´¹è®°å½•å¤±è´¥: ' + err.message);
                } finally {
                    setPaymentsLoading(false);
                }
            };

            const reconcileStripe = async () => {
                setStripeSyncMsg('');
                setStripeSyncing(true);
                try {
                    const res = await api('/payments/stripe/reconcile', 'POST', { limit: 200 });
                    if (typeof res?.data?.balance === 'number') {
                        setBalance(res.data.balance);
                        const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
                        storedUser.balance = res.data.balance;
                        localStorage.setItem('user', JSON.stringify(storedUser));
                    }
                    const s = res?.data?.stats;
                    if (s) {
                        setStripeSyncMsg(`å·²åŒæ­¥ï¼šå…¥è´¦ ${s.credited} ç¬”ï¼Œå¤±è´¥ ${s.failed} ç¬”ï¼Œä»å¾…å¤„ç† ${s.pending} ç¬”ã€‚`);
                        console.log('[Stripe] reconcile stats:', s);
                    } else {
                        setStripeSyncMsg('å·²åŒæ­¥ Stripe è®¢å•ã€‚');
                    }
                    await fetchPayments();
                } catch (e) {
                    setStripeSyncMsg('åŒæ­¥å¤±è´¥ï¼š' + (e?.message || 'æœªçŸ¥é”™è¯¯'));
                } finally {
                    setStripeSyncing(false);
                }
            };

            // Auto reconcile once when wallet opens and there are pending Stripe deposits
            useEffect(() => {
                if (activeTab !== 'wallet') return;
                if (stripeSyncing) return;
                if (stripeAutoSyncTried) return;
                const hasPendingStripe = (payments || []).some(p => p.type === 'deposit' && p.status === 'pending' && String(p.transactionId || '').startsWith('cs_'));
                if (!hasPendingStripe) return;
                setStripeAutoSyncTried(true);
                reconcileStripe();
            }, [activeTab, paymentsLoading, payments, stripeSyncing, stripeAutoSyncTried]);

            const handleTopUp = async () => {
                const amount = Number(topupAmount);
                if (!Number.isFinite(amount) || amount <= 0) {
                    alert('è¯·è¾“å…¥æ­£ç¡®çš„å……å€¼é‡‘é¢');
                    return;
                }
                setTopupLoading(true);
                try {
                    // Real Stripe test payment: create checkout session then redirect
                    const res = await api('/payments/stripe/checkout-session', 'POST', { amount });
                    const url = res?.data?.url;
                    const sessionId = res?.data?.sessionId;
                    if (!url) throw new Error('Stripe session åˆ›å»ºå¤±è´¥ï¼ˆç¼ºå°‘è·³è½¬é“¾æ¥ï¼‰');
                    // å…³é”®ï¼šæŠŠ session_id ç¼“å­˜èµ·æ¥ï¼Œé˜²æ­¢ Stripe å›è·³æ—¶ query ä¸¢å¤±å¯¼è‡´æ— æ³•å…¥è´¦
                    try {
                        if (sessionId) {
                            localStorage.setItem('stripe_last_session_id', String(sessionId));
                            localStorage.setItem('stripe_last_amount', String(amount));
                            localStorage.setItem('stripe_last_ts', String(Date.now()));
                        }
                    } catch (e) {}
                    window.location.href = url;
                } catch (err) {
                    alert('å……å€¼å¤±è´¥: ' + err.message);
                } finally {
                    setTopupLoading(false);
                }
            };

            const clearStripeParams = () => {
                const params = new URLSearchParams(window.location.search);
                params.delete('stripe_session_id');
                params.delete('stripe_cancelled');
                const next = `${window.location.pathname}?${params.toString()}`.replace(/\?$/, '');
                window.history.replaceState({}, '', next);
            };

            const confirmStripeSession = async (sessionId, opts = {}) => {
                const { maxAttempts = 20, intervalMs = 1200 } = opts;
                setStripeConfirmError('');
                setStripeConfirming(true);
                try {
                    for (let i = 0; i < maxAttempts; i++) {
                        try {
                            const res = await api(`/payments/stripe/confirm?session_id=${encodeURIComponent(sessionId)}`, 'GET');
                            if (typeof res?.data?.balance === 'number') {
                                setBalance(res.data.balance);
                                const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
                                storedUser.balance = res.data.balance;
                                localStorage.setItem('user', JSON.stringify(storedUser));
                            }
                            await fetchPayments();
                            clearStripeParams();
                            setStripeSessionId('');
                            try {
                                localStorage.removeItem('stripe_last_session_id');
                                localStorage.removeItem('stripe_last_amount');
                                localStorage.removeItem('stripe_last_ts');
                            } catch (e) {}
                            if (typeof res?.data?.balance === 'number') {
                                setStripeSyncMsg(`å……å€¼å·²å…¥è´¦ï¼Œå½“å‰ä½™é¢ â‚¬${res.data.balance}`);
                            }
                            return { ok: true, res };
                        } catch (e) {
                            const msg = String(e?.message || '');
                            // Stripe æ”¯ä»˜æˆåŠŸåï¼Œpayment_status å¯èƒ½å»¶è¿Ÿå‡ ç§’æ‰å˜ paidï¼›è¿™ç§é”™è¯¯éœ€è¦é‡è¯•
                            if (msg.includes('Payment not completed')) {
                                await new Promise(r => setTimeout(r, intervalMs));
                                continue;
                            }
                            // å…¶å®ƒé”™è¯¯ç›´æ¥æŠ›å‡º
                            throw e;
                        }
                    }
                    throw new Error('æ”¯ä»˜å·²å®Œæˆä½†å…¥è´¦ç¡®è®¤è¶…æ—¶ï¼Œè¯·ç¨åç‚¹å‡»â€œé‡è¯•å…¥è´¦â€ã€‚');
                } catch (e) {
                    setStripeConfirmError(e?.message || 'å…¥è´¦ç¡®è®¤å¤±è´¥');
                    return { ok: false, error: e };
                } finally {
                    setStripeConfirming(false);
                }
            };

            // Stripe return: confirm and credit balance (no webhook required)
            useEffect(() => {
                try {
                    const params = new URLSearchParams(window.location.search);
                    const tab = params.get('tab');
                    const sessionId = params.get('stripe_session_id');
                    const cancelled = params.get('stripe_cancelled');
                    // UXï¼šå›è·³æ—¶å¦‚æœå¸¦ tab=walletï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°é’±åŒ…é¡µï¼›ä½†å…¥è´¦ç¡®è®¤ä¸åº”ä¾èµ– tab
                    if (tab === 'wallet' && activeTab !== 'wallet') setActiveTab('wallet');
                    if (cancelled === '1') {
                        // æ¸…ç†å‚æ•°
                        clearStripeParams();
                        return;
                    }
                    // å…³é”®ï¼šä¼˜å…ˆç”¨ URL çš„ session_idï¼›å¦‚æœ URL ä¸¢å‚ï¼Œåˆ™ç”¨æœ¬åœ°ç¼“å­˜å…œåº•
                    let sid = sessionId;
                    if (!sid) {
                        try { sid = localStorage.getItem('stripe_last_session_id') || ''; } catch (e) { sid = ''; }
                    }
                    if (!sid) return;
                    if (stripeConfirming) return;
                    if (stripeSessionId && stripeSessionId === sid) return;
                    setStripeSessionId(sid);
                    confirmStripeSession(sid);
                } catch (e) {}
            }, [activeTab, stripeConfirming, stripeSessionId]);

            const handleUnlock = async (leadId) => {
                if (!confirm(`ç¡®è®¤èŠ±è´¹ 1â‚¬ è§£é”æ­¤æ¡çº¿ç´¢å—ï¼Ÿ\nå½“å‰ä½™é¢: ${balance}â‚¬`)) return;

                try {
                    const res = await api(`/leads/${leadId}/unlock`, 'POST');
                    // æ›´æ–°æœ¬åœ°åˆ—è¡¨çŠ¶æ€
                    setLeads(leads.map(l => l._id === leadId ? res.data.lead : l));
                    if (typeof res?.data?.balance === 'number') {
                        setBalance(res.data.balance);
                        // åŒæ­¥æœ¬åœ° userï¼Œé¿å…åˆ·æ–°åä½™é¢å›åˆ°æ—§å€¼
                        const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
                        storedUser.balance = res.data.balance;
                        localStorage.setItem('user', JSON.stringify(storedUser));
                    } else {
                        // å…œåº•ï¼šåç«¯æœªè¿”å› balance æ—¶æŒ‰ 1â‚¬ æ‰£å‡
                        setBalance(prev => prev - 1);
                    }
                    alert('è§£é”æˆåŠŸï¼');
                } catch (err) {
                    alert('è§£é”å¤±è´¥: ' + err.message);
                    if (err.message.includes('Insufficient balance')) {
                        setActiveTab('wallet');
                    }
                }
            };

            return (
                <div className="min-h-screen flex flex-col">
                    {/* Header */}
                    <header className="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-10">
                        <div className="flex items-center gap-2">
                            <div className="bg-blue-600 text-white p-2 rounded-lg font-bold">L</div>
                            <span className="font-bold text-gray-800 text-lg">æˆ¿ä¸œå·¥ä½œå°</span>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="text-right">
                                <p className="text-sm font-bold text-gray-800">{user.name}</p>
                                <p className="text-xs text-gray-500">ä½™é¢: <span className="text-green-600 font-bold">{balance}â‚¬</span></p>
                            </div>
                            <button onClick={onLogout} className="text-gray-400 hover:text-red-500">
                                <LucideIcon name="log-out" size={20} />
                            </button>
                        </div>
                    </header>

                    {/* Navigation Tabs */}
                    <div className="bg-white border-b border-gray-200 px-6">
                        <div className="flex gap-6 max-w-6xl mx-auto">
                            <button 
                                onClick={() => setActiveTab('leads')}
                                className={`py-4 font-bold text-sm border-b-2 transition-colors ${activeTab === 'leads' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                            >
                                ç§Ÿå®¢çº¿ç´¢
                            </button>
                            <button 
                                onClick={() => setActiveTab('listings')}
                                className={`py-4 font-bold text-sm border-b-2 transition-colors ${activeTab === 'listings' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                            >
                                æˆ¿æºç®¡ç†
                            </button>
                            <button 
                                onClick={() => setActiveTab('wallet')}
                                className={`py-4 font-bold text-sm border-b-2 transition-colors ${activeTab === 'wallet' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                            >
                                é’±åŒ…/å……å€¼
                            </button>
                            <button 
                                onClick={() => setActiveTab('settings')}
                                className={`py-4 font-bold text-sm border-b-2 transition-colors ${activeTab === 'settings' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                            >
                                è´¦å·è®¾ç½®
                            </button>
                        </div>
                    </div>

                    {/* Content */}
                    <main className="flex-1 max-w-6xl mx-auto w-full p-6">
                        {activeTab === 'listings' ? (
                            <ListingsPanel userId={user._id} onBalanceUpdate={(b) => setBalance(b)} />
                        ) : activeTab === 'wallet' ? (
                            <div className="space-y-6">
                                {(stripeConfirming || stripeConfirmError) && (
                                    <div className={`p-4 rounded-2xl border ${stripeConfirmError ? 'bg-red-50 border-red-200' : 'bg-blue-50 border-blue-200'}`}>
                                        <div className="flex items-start justify-between gap-4">
                                            <div className="min-w-0">
                                                <div className={`font-bold ${stripeConfirmError ? 'text-red-700' : 'text-blue-800'}`}>
                                                    {stripeConfirmError ? 'å…¥è´¦ç¡®è®¤å¤±è´¥' : 'æ­£åœ¨ç¡®è®¤å…¥è´¦...'}
                                                </div>
                                                <div className={`text-sm mt-1 ${stripeConfirmError ? 'text-red-700' : 'text-blue-700'}`}>
                                                    {stripeConfirmError
                                                        ? stripeConfirmError
                                                        : 'Stripe æ”¯ä»˜æˆåŠŸåå¯èƒ½éœ€è¦å‡ ç§’åŒæ­¥ï¼Œè¯·ç¨ç­‰ã€‚'}
                                                </div>
                                                {stripeSessionId && (
                                                    <div className="text-xs mt-2 text-gray-500 break-all">
                                                        session_id: {stripeSessionId}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex gap-2 flex-shrink-0">
                                                {stripeConfirmError && stripeSessionId && (
                                                    <button
                                                        onClick={() => confirmStripeSession(stripeSessionId)}
                                                        className="px-4 py-2 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700"
                                                    >
                                                        é‡è¯•å…¥è´¦
                                                    </button>
                                                )}
                                                <button
                                                    onClick={() => { setStripeConfirmError(''); setStripeSessionId(''); clearStripeParams(); }}
                                                    className="px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 font-bold hover:bg-gray-50"
                                                >
                                                    å…³é—­
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {stripeSyncMsg && (
                                    <div className="p-4 rounded-2xl border border-gray-200 bg-white text-sm text-gray-700">
                                        {stripeSyncMsg}
                                    </div>
                                )}
                                <div className="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-bold text-gray-800">é’±åŒ… / å……å€¼ï¼ˆStripeï¼‰</h2>
                                        <button
                                            onClick={reconcileStripe}
                                            disabled={stripeSyncing}
                                            className="text-sm font-bold text-blue-600 hover:underline disabled:opacity-50"
                                        >
                                            {stripeSyncing ? 'åŒæ­¥ä¸­...' : 'åŒæ­¥Stripeè®¢å•'}
                                        </button>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                        <div className="md:col-span-1">
                                            <div className="text-sm text-gray-500 mb-1">å½“å‰ä½™é¢</div>
                                            <div className="text-3xl font-extrabold text-gray-900">â‚¬{balance}</div>
                                        </div>
                                        <div className="md:col-span-1">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">å……å€¼é‡‘é¢ (â‚¬)</label>
                                            <input
                                                type="number"
                                                className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none"
                                                value={topupAmount}
                                                onChange={(e) => setTopupAmount(e.target.value)}
                                                min="1"
                                            />
                                        </div>
                                        <div className="md:col-span-1">
                                            <button
                                                onClick={handleTopUp}
                                                disabled={topupLoading}
                                                className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 disabled:opacity-50"
                                            >
                                                {topupLoading ? 'å……å€¼ä¸­...' : 'ç«‹å³å……å€¼'}
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-bold text-gray-800">å……å€¼/æ¶ˆè´¹è®°å½•</h3>
                                        <div className="flex items-center gap-3">
                                            <button
                                                onClick={() => setShowNonCompletedPayments(v => !v)}
                                                className="text-sm font-bold text-gray-600 hover:underline"
                                            >
                                                {showNonCompletedPayments ? 'éšè—æœªå®Œæˆè®°å½•' : 'æŸ¥çœ‹æœªå®Œæˆè®°å½•'}
                                            </button>
                                            <button onClick={fetchPayments} className="text-sm font-bold text-blue-600 hover:underline">åˆ·æ–°</button>
                                        </div>
                                    </div>
                                    {(() => {
                                        const completed = (payments || []).filter(p => String(p.status || '').toLowerCase() === 'completed');
                                        const nonCompleted = (payments || []).filter(p => String(p.status || '').toLowerCase() !== 'completed');

                                        if (paymentsLoading) {
                                            return <div className="text-gray-500 py-8 text-center">åŠ è½½ä¸­...</div>;
                                        }

                                        if (completed.length === 0 && !showNonCompletedPayments) {
                                            return <div className="text-gray-500 py-8 text-center">æš‚æ— å·²å®Œæˆè®°å½•</div>;
                                        }

                                        return (
                                            <div className="space-y-4">
                                                <div className="overflow-x-auto">
                                                    <table className="min-w-full text-sm">
                                                        <thead>
                                                            <tr className="text-left text-gray-500 border-b">
                                                                <th className="py-2 pr-4">æ—¶é—´</th>
                                                                <th className="py-2 pr-4">ç±»å‹</th>
                                                                <th className="py-2 pr-4">é‡‘é¢</th>
                                                                <th className="py-2 pr-4">çŠ¶æ€</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {completed.map(p => (
                                                                <tr key={p._id} className="border-b last:border-b-0">
                                                                    <td className="py-2 pr-4 text-gray-600 whitespace-nowrap">{new Date(p.createdAt).toLocaleString()}</td>
                                                                    <td className="py-2 pr-4 font-medium text-gray-800">{p.type}</td>
                                                                    <td className={`py-2 pr-4 font-bold ${Number(p.amount) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                                        {Number(p.amount) >= 0 ? '+' : ''}{p.amount}â‚¬
                                                                    </td>
                                                                    <td className="py-2 pr-4 text-green-700 font-bold">completed</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>

                                                {showNonCompletedPayments && nonCompleted.length > 0 && (
                                                    <div className="rounded-2xl border border-gray-200 bg-gray-50 p-4">
                                                        <div className="flex items-center justify-between gap-3">
                                                            <div className="font-bold text-gray-800">æœªå®Œæˆè®°å½•ï¼ˆpending/failedï¼‰</div>
                                                            <div className="text-xs text-gray-500">
                                                                è¿™äº›è®°å½•ä¸ä»£è¡¨å·²æ‰£æ¬¾ï¼›å¯èƒ½æ˜¯å–æ¶ˆã€å¤±è´¥ã€æˆ–ä»åœ¨ç­‰å¾… Stripe å›æ‰§ã€‚
                                                            </div>
                                                        </div>
                                                        <div className="overflow-x-auto mt-3">
                                                            <table className="min-w-full text-sm">
                                                                <thead>
                                                                    <tr className="text-left text-gray-500 border-b">
                                                                        <th className="py-2 pr-4">æ—¶é—´</th>
                                                                        <th className="py-2 pr-4">ç±»å‹</th>
                                                                        <th className="py-2 pr-4">é‡‘é¢</th>
                                                                        <th className="py-2 pr-4">çŠ¶æ€</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {nonCompleted.map(p => (
                                                                        <tr key={p._id} className="border-b last:border-b-0">
                                                                            <td className="py-2 pr-4 text-gray-600 whitespace-nowrap">{new Date(p.createdAt).toLocaleString()}</td>
                                                                            <td className="py-2 pr-4 font-medium text-gray-800">{p.type}</td>
                                                                            <td className={`py-2 pr-4 font-bold ${Number(p.amount) >= 0 ? 'text-gray-700' : 'text-red-600'}`}>
                                                                                {Number(p.amount) >= 0 ? '+' : ''}{p.amount}â‚¬
                                                                            </td>
                                                                            <td className="py-2 pr-4 text-gray-700">{p.status}</td>
                                                                        </tr>
                                                                    ))}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })()}
                                </div>
                            </div>
                        ) : activeTab === 'settings' ? (
                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                                    <h2 className="text-xl font-bold text-gray-800 mb-4">è´¦å·ä¿¡æ¯</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label className="text-sm text-gray-500 mb-1 block">æ˜µç§°</label>
                                            <input
                                                type="text"
                                                className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="å¡«å†™æ˜µç§°ï¼ˆå±•ç¤ºç»™ç§Ÿå®¢ï¼‰"
                                                value={profileForm.name}
                                                onChange={(e) => setProfileForm(prev => ({ ...prev, name: e.target.value }))}
                                            />
                                        </div>
                                        <div>
                                            <label className="text-sm text-gray-500 mb-1 block">é‚®ç®±</label>
                                            <input
                                                type="email"
                                                className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="å¡«å†™é‚®ç®±ï¼ˆç”¨äºç™»å½•ï¼‰"
                                                value={profileForm.email}
                                                onChange={(e) => setProfileForm(prev => ({ ...prev, email: e.target.value }))}
                                            />
                                        </div>
                                        <div>
                                            <label className="text-sm text-gray-500 mb-1 block">å¾®ä¿¡å·</label>
                                            <input
                                                type="text"
                                                className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="å¡«å†™å¾®ä¿¡å·ï¼ˆç»™ç§Ÿå®¢è”ç³»ï¼‰"
                                                value={profileForm.wechatId}
                                                onChange={(e) => setProfileForm(prev => ({ ...prev, wechatId: e.target.value }))}
                                            />
                                        </div>
                                    </div>
                                    <div className="mt-6 flex flex-col md:flex-row gap-3">
                                        <button
                                            onClick={async () => {
                                                const payload = {
                                                    name: String(profileForm.name || '').trim(),
                                                    email: String(profileForm.email || '').trim(),
                                                    wechatId: String(profileForm.wechatId || '').trim()
                                                };
                                                if (!payload.email) return alert('è¯·å¡«å†™é‚®ç®±');
                                                if (!payload.wechatId) return alert('è¯·å¡«å†™å¾®ä¿¡å·');
                                                if (!payload.name) return alert('è¯·å¡«å†™æ˜µç§°');
                                                setProfileSaving(true);
                                                try {
                                                    const res = await api('/auth/me', 'PATCH', payload);
                                                    const newUser = res?.data?.user;
                                                    if (!newUser) throw new Error('è¿”å›æ•°æ®å¼‚å¸¸');

                                                    // åŒæ­¥ä½™é¢ï¼ˆåç«¯è¿”å› user é‡Œä¹Ÿæœ‰ balanceï¼›ä½†ä»¥ç°æœ‰ balance state ä¸ºå‡†ï¼‰
                                                    newUser.balance = typeof newUser.balance === 'number' ? newUser.balance : balance;

                                                    localStorage.setItem('user', JSON.stringify(newUser));
                                                    if (typeof onUserUpdate === 'function') onUserUpdate(newUser);
                                                    alert('ä¿å­˜æˆåŠŸ');
                                                } catch (e) {
                                                    alert('ä¿å­˜å¤±è´¥ï¼š' + (e?.message || 'æœªçŸ¥é”™è¯¯'));
                                                } finally {
                                                    setProfileSaving(false);
                                                }
                                            }}
                                            disabled={profileSaving}
                                            className="px-6 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 disabled:opacity-50"
                                        >
                                            {profileSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜ä¿®æ”¹'}
                                        </button>
                                        <button
                                            onClick={() => setProfileForm({ name: user.name || '', email: user.email || '', wechatId: user.wechatId || '' })}
                                            disabled={profileSaving}
                                            className="px-6 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 disabled:opacity-50"
                                        >
                                            å–æ¶ˆ
                                        </button>
                                        <a href="/index.html" className="px-6 py-3 bg-white border border-gray-200 text-gray-800 font-bold rounded-xl hover:bg-gray-50 text-center">
                                            è¿”å›å‰å°é¦–é¡µ
                                        </a>
                                        <button onClick={onLogout} className="px-6 py-3 bg-red-50 text-red-600 font-bold rounded-xl hover:bg-red-100">é€€å‡ºç™»å½•</button>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="text-gray-500 text-sm mb-1">å¯ç”¨ä½™é¢</h3>
                                <p className="text-3xl font-bold text-gray-800">â‚¬{balance}</p>
                                <button onClick={() => setActiveTab('wallet')} className="mt-4 w-full py-2 bg-blue-50 text-blue-600 rounded-lg text-sm font-bold hover:bg-blue-100">ç«‹å³å……å€¼</button>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="text-gray-500 text-sm mb-1">å·²è§£é”çº¿ç´¢</h3>
                                <p className="text-3xl font-bold text-gray-800">{leads.filter(l => l.isUnlocked).length}</p>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="text-gray-500 text-sm mb-1">æ–°çº¿ç´¢ (å¾…å¤„ç†)</h3>
                                <p className="text-3xl font-bold text-green-600">{leads.filter(l => !l.isUnlocked).length}</p>
                            </div>
                        </div>

                        <h2 className="text-xl font-bold text-gray-800 mb-4">æœ€æ–°ç§Ÿå®¢éœ€æ±‚</h2>
                        
                        {loading ? (
                            <p className="text-center py-10 text-gray-500">åŠ è½½ä¸­...</p>
                        ) : leads.length === 0 ? (
                            <div className="bg-white rounded-2xl border border-gray-100 shadow-sm p-8 text-center">
                                <div className="text-gray-800 font-bold text-lg mb-2">æš‚æ— ç§Ÿå®¢çº¿ç´¢</div>
                                <div className="text-gray-500 text-sm mb-6">
                                    çº¿ç´¢ç”±ç§Ÿå®¢åœ¨â€œå‘å¸ƒæ±‚ç§Ÿâ€å…¥å£æäº¤ã€‚ä½ å¯ä»¥å…ˆå‘å¸ƒæˆ¿æºï¼Œæˆ–æ‰“å¼€æ±‚ç§Ÿé¡µåˆ›å»ºæµ‹è¯•æ•°æ®ã€‚
                                </div>
                                <div className="flex gap-3 justify-center">
                                    <a href="/tenant" className="px-6 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700">æ‰“å¼€å‘å¸ƒæ±‚ç§Ÿé¡µ</a>
                                    <button onClick={fetchLeads} className="px-6 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200">åˆ·æ–°</button>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {leads.map(lead => (
                                    <div key={lead._id} className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                                        <div className="flex flex-col md:flex-row justify-between gap-4">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-2">
                                                    <span className="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded">
                                                        é¢„ç®—: â‚¬{lead.budget || 'é¢è®®'}
                                                    </span>
                                                    <span className="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded">
                                                        å…¥ä½: {lead.moveInDate ? new Date(lead.moveInDate).toLocaleDateString() : 'éšæ—¶'}
                                                    </span>
                                                    <span className="text-gray-400 text-xs">
                                                        {new Date(lead.createdAt).toLocaleString()}
                                                    </span>
                                                </div>
                                                <p className="text-gray-800 font-medium mb-3">{lead.requirement}</p>
                                                
                                                {/* è”ç³»æ–¹å¼åŒºåŸŸ */}
                                                <div className={`p-3 rounded-xl border ${lead.isUnlocked ? 'bg-green-50 border-green-100' : (lead.reviewStatus !== 'approved' ? 'bg-yellow-50 border-yellow-200' : 'bg-gray-50 border-gray-200 border-dashed')}`}>
                                                    {lead.isUnlocked ? (
                                                        <div className="flex items-center gap-4 text-sm text-green-800">
                                                            <span><span className="font-bold">å¾®ä¿¡:</span> {lead.wechatId}</span>
                                                            {lead.phone && <span><span className="font-bold">ç”µè¯:</span> {lead.phone}</span>}
                                                        </div>
                                                    ) : lead.reviewStatus !== 'approved' ? (
                                                        <div className="flex items-center justify-between text-sm text-yellow-800">
                                                            <span>è¯¥çº¿ç´¢å¾…å®¡æ ¸ï¼ˆå®¡æ ¸é€šè¿‡åæ‰èƒ½ä»˜è´¹è§£é”ï¼‰</span>
                                                            <div className="flex items-center gap-1 text-yellow-700 font-bold">
                                                                <LucideIcon name="shield-alert" size={14} />
                                                                å¾…å®¡æ ¸
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div className="flex items-center justify-between text-sm text-gray-500">
                                                            <span>è”ç³»æ–¹å¼å·²éšè—</span>
                                                            <div className="flex items-center gap-1 text-orange-500">
                                                                <LucideIcon name="lock" size={14} />
                                                                éœ€ä»˜è´¹è§£é”
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>

                                            <div className="flex items-center">
                                                {!lead.isUnlocked ? (
                                                    <button 
                                                        onClick={() => handleUnlock(lead._id)}
                                                        disabled={lead.reviewStatus !== 'approved'}
                                                        className="w-full md:w-auto px-6 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold rounded-xl shadow-lg hover:brightness-110 active:scale-95 transition-all whitespace-nowrap"
                                                    >
                                                        {lead.reviewStatus !== 'approved' ? 'å¾…å®¡æ ¸' : '1â‚¬ è§£é”è”ç³»æ–¹å¼'}
                                                    </button>
                                                ) : (
                                                    <button disabled className="w-full md:w-auto px-6 py-3 bg-gray-100 text-gray-400 font-bold rounded-xl cursor-not-allowed">
                                                        å·²è§£é”
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        </>
                        )}
                    </main>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);

            useEffect(() => {
                const storedToken = localStorage.getItem('token');
                const storedUser = localStorage.getItem('user');
                if (storedToken && storedUser) {
                    setUser(JSON.parse(storedUser));
                }
            }, []);

            const handleLogout = () => {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                setUser(null);
            };

            return user ? <Dashboard user={user} onLogout={handleLogout} onUserUpdate={setUser} /> : <AuthPage onLogin={setUser} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
